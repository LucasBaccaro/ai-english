# Plan de Desarrollo - App de Llamada de Voz en Vivo con OpenAI Realtime API

## üéØ Objetivo
Crear una aplicaci√≥n KMP (Kotlin Multiplatform) con Compose Multiplatform para iOS y Android que permita conversaciones de voz en tiempo real con IA usando OpenAI Realtime API a trav√©s de WebRTC.

## üèóÔ∏è Arquitectura
- **Frontend:** Compose Multiplatform (iOS + Android)
- **WebRTC:** `webrtc-kmp` biblioteca multiplatform
- **Networking:** Ktor Client
- **Serializaci√≥n:** Kotlinx Serialization
- **Backend:** Sin backend por ahora (API key hardcoded temporalmente)

---

## ‚úÖ COMPLETADO

### Fase 1: Setup de Dependencias y Configuraci√≥n
**Estado:** ‚úÖ Completado

**Archivos modificados:**
- `gradle/libs.versions.toml` - Agregadas versiones de dependencias
- `build.gradle.kts` (ra√≠z) - Agregados plugins
- `composeApp/build.gradle.kts` - Configuraci√≥n de dependencias y CocoaPods
- `iosApp/Podfile` - Configuraci√≥n de CocoaPods

**Dependencias agregadas:**
- ‚úÖ `webrtc-kmp:0.125.0` - WebRTC multiplatform
- ‚úÖ `ktor-client-core:3.0.3` - Cliente HTTP
- ‚úÖ `ktor-client-content-negotiation:3.0.3` - Negociaci√≥n de contenido
- ‚úÖ `ktor-serialization-kotlinx-json:3.0.3` - Serializaci√≥n JSON
- ‚úÖ `ktor-client-logging:3.0.3` - Logging
- ‚úÖ `ktor-client-android:3.0.3` - Engine Android
- ‚úÖ `ktor-client-darwin:3.0.3` - Engine iOS
- ‚úÖ `kotlinx-serialization-json:1.8.0` - Serializaci√≥n
- ‚úÖ `kotlinx-coroutines-core:1.10.2` - Corrutinas
- ‚úÖ `kotlinx-datetime:0.6.1` - Manejo de fechas

**CocoaPods configurado:**
- ‚úÖ Plugin `kotlin("native.cocoapods")` aplicado
- ‚úÖ WebRTC-SDK v125.6422.05 agregado al Podfile
- ‚úÖ `pod install` ejecutado exitosamente

### Fase 2: Modelos de Datos
**Estado:** ‚úÖ Completado

**Archivos creados:**

1. **`composeApp/src/commonMain/kotlin/com/baccaro/ai/domain/models/openai/ClientEvents.kt`**
   - ‚úÖ `SessionUpdateEvent` - Configurar sesi√≥n
   - ‚úÖ `ConversationItemCreateEvent` - Crear mensajes
   - ‚úÖ `ResponseCreateEvent` - Solicitar respuesta
   - ‚úÖ `InputAudioBufferAppendEvent` - Enviar audio
   - ‚úÖ `InputAudioBufferCommitEvent` - Confirmar audio
   - ‚úÖ `InputAudioBufferClearEvent` - Limpiar buffer
   - ‚úÖ Modelos de configuraci√≥n: `SessionConfig`, `AudioConfig`, `TurnDetection`, etc.

2. **`composeApp/src/commonMain/kotlin/com/baccaro/ai/domain/models/openai/ServerEvents.kt`**
   - ‚úÖ `SessionCreatedEvent`, `SessionUpdatedEvent` - Eventos de sesi√≥n
   - ‚úÖ `InputAudioBufferSpeechStarted/StoppedEvent` - Detecci√≥n de voz
   - ‚úÖ `ConversationItem*` - Eventos de conversaci√≥n
   - ‚úÖ `Response*` - Eventos de respuesta
   - ‚úÖ `ResponseOutputText/AudioDeltaEvent` - Streaming de texto/audio
   - ‚úÖ `ResponseOutputAudioTranscriptDeltaEvent` - Transcripciones
   - ‚úÖ `ResponseFunctionCall*` - Function calling
   - ‚úÖ `ErrorEvent` - Manejo de errores
   - ‚úÖ `RateLimitsUpdatedEvent` - L√≠mites de uso
   - ‚úÖ Modelos de soporte: `SessionInfo`, `ResponseInfo`, `UsageInfo`, etc.

3. **`composeApp/src/commonMain/kotlin/com/baccaro/ai/domain/models/ui/CallModels.kt`**
   - ‚úÖ `Message` - Modelo de mensaje en la conversaci√≥n
   - ‚úÖ `CallState` - Estado de la llamada
   - ‚úÖ `CallEvent` - Eventos de UI
   - ‚úÖ `ConversationState` - Estado completo de la conversaci√≥n

**Compilaci√≥n verificada:**
- ‚úÖ `./gradlew :composeApp:compileCommonMainKotlinMetadata` - BUILD SUCCESSFUL

### Fase 3: WebRTC Integration con webrtc-kmp
**Estado:** ‚úÖ Completado

**Tareas completadas:**
- ‚úÖ Crear `RealtimeWebRTCManager` en commonMain
- ‚úÖ Inicializar `PeerConnection` con configuraci√≥n adecuada
- ‚úÖ Configurar audio local (micr√≥fono) con `MediaDevices.getUserMedia()`
- ‚úÖ Configurar `DataChannel` para eventos JSON con flows
- ‚úÖ Manejar audio remoto (respuesta de la IA) con `onTrack` flow
- ‚úÖ Implementar observers para eventos WebRTC usando flows
- ‚úÖ Crear `EventParser` para serializaci√≥n/deserializaci√≥n de eventos

**Archivos creados:**
- `composeApp/src/commonMain/kotlin/com/baccaro/ai/data/webrtc/RealtimeWebRTCManager.kt` ‚úÖ
- `composeApp/src/commonMain/kotlin/com/baccaro/ai/data/webrtc/EventParser.kt` ‚úÖ

**Compilaci√≥n verificada:**
- ‚úÖ `./gradlew :composeApp:compileCommonMainKotlinMetadata` - BUILD SUCCESSFUL

**Detalles de implementaci√≥n:**
- Usa webrtc-kmp v0.125.0 con API basada en Flows
- `PeerConnection` creada directamente sin factory
- `MediaDevices.getUserMedia()` para obtener audio del micr√≥fono
- Observers implementados con `onIceCandidate`, `onTrack`, `onConnectionStateChange`, etc.
- `DataChannel` con flows `onMessage`, `onOpen`, `onClose` para eventos JSON
- `EventParser` maneja 25+ tipos de eventos del servidor y 6 tipos de eventos del cliente

---

## üöß EN PROGRESO

*(Ninguna fase en progreso actualmente)*

---

## üìã PENDIENTE

### Fase 4: OpenAI Realtime Client
**Estado:** ‚úÖ Completado

**Tareas completadas:**
- ‚úÖ Crear `OpenAIRealtimeClient` en commonMain
- ‚úÖ Implementar generaci√≥n de tokens (temporal con API key hardcoded)
- ‚úÖ Establecer conexi√≥n WebRTC con OpenAI
  - ‚úÖ Crear offer SDP
  - ‚úÖ Enviar a `/v1/realtime` endpoint
  - ‚úÖ Aplicar answer SDP
- ‚úÖ Configurar sesi√≥n con VAD autom√°tico (server_vad)
- ‚úÖ Implementar `EventHandler` para procesar eventos del servidor
- ‚úÖ Manejar ciclo de vida de la sesi√≥n (connect/disconnect)

**Archivos creados:**
- `composeApp/src/commonMain/kotlin/com/baccaro/ai/data/openai/OpenAIRealtimeClient.kt` ‚úÖ
- `composeApp/src/commonMain/kotlin/com/baccaro/ai/data/openai/EventHandler.kt` ‚úÖ

**Compilaci√≥n verificada:**
- ‚úÖ `./gradlew :composeApp:compileCommonMainKotlinMetadata` - BUILD SUCCESSFUL

**Detalles de implementaci√≥n:**
- Cliente HTTP con Ktor para comunicaci√≥n con OpenAI API
- Flujo completo de conexi√≥n WebRTC (offer ‚Üí POST ‚Üí answer)
- Configuraci√≥n de sesi√≥n con:
  - Server VAD (Voice Activity Detection) autom√°tico
  - Audio PCM16 a 24kHz
  - Transcripciones con Whisper
  - Voz configurable (alloy por defecto)
- EventHandler con callbacks para 20+ tipos de eventos
- M√©todos para enviar mensajes de texto y controlar mute
- Manejo de estados de conexi√≥n expuestos como StateFlows

### Fase 5: Audio & Permissions
**Estado:** ‚è≥ Pendiente

**Android (androidMain):**
- [ ] Implementar request de permiso `RECORD_AUDIO`
- [ ] Crear `AndroidAudioManager` si es necesario
- [ ] Actualizar `AndroidManifest.xml` con permisos

**iOS (iosMain):**
- [ ] Agregar `NSMicrophoneUsageDescription` a Info.plist
- [ ] Implementar request de permiso con `AVAudioSession`
- [ ] Crear `IOSAudioManager` si es necesario

**Archivos a crear/modificar:**
- `composeApp/src/androidMain/kotlin/com/baccaro/ai/platform/AudioManager.android.kt`
- `composeApp/src/iosMain/kotlin/com/baccaro/ai/platform/AudioManager.ios.kt`
- `composeApp/src/androidMain/AndroidManifest.xml`
- `iosApp/iosApp/Info.plist`

### Fase 6: UI con Compose Multiplatform
**Estado:** ‚è≥ Pendiente

**Tareas:**
- [ ] Crear `CallViewModel` con StateFlow
- [ ] Implementar `CallScreen` composable
- [ ] Crear componentes:
  - [ ] `CallHeader` - Estado de conexi√≥n
  - [ ] `MessageList` - Lista de transcripciones
  - [ ] `MessageBubble` - Burbuja de mensaje
  - [ ] `CallControls` - Botones de control
  - [ ] `SpeakingIndicator` - Indicador de quien habla
- [ ] Integrar con navegaci√≥n de la app

**Archivos a crear:**
- `composeApp/src/commonMain/kotlin/com/baccaro/ai/presentation/call/CallViewModel.kt`
- `composeApp/src/commonMain/kotlin/com/baccaro/ai/presentation/call/CallScreen.kt`
- `composeApp/src/commonMain/kotlin/com/baccaro/ai/presentation/call/components/`

### Fase 7: Testing e Integraci√≥n
**Estado:** ‚è≥ Pendiente

**Tareas:**
- [ ] Testing en Android:
  - [ ] Compilar y ejecutar app
  - [ ] Probar inicio de llamada
  - [ ] Verificar audio bidireccional
  - [ ] Probar transcripciones en tiempo real
  - [ ] Verificar VAD autom√°tico
- [ ] Testing en iOS:
  - [ ] Compilar y ejecutar app
  - [ ] Probar las mismas funcionalidades que Android
- [ ] Manejo de errores:
  - [ ] Conexi√≥n perdida
  - [ ] Permisos denegados
  - [ ] Errores de API
- [ ] Optimizaciones de performance

---

## üîß Configuraci√≥n T√©cnica

### OpenAI Realtime API - Configuraci√≥n Planeada
```kotlin
SessionConfig(
    type = "realtime",
    model = "gpt-realtime",
    outputModalities = listOf("audio", "text"),
    audio = AudioConfig(
        input = AudioInputConfig(
            format = AudioFormat(type = "audio/pcm", rate = 24000),
            turnDetection = TurnDetection(type = "semantic_vad")
        ),
        output = AudioOutputConfig(
            format = AudioFormat(type = "audio/pcm"),
            voice = "alloy" // o "ash", "ballad", "coral", "echo", "sage", "shimmer", "verse"
        )
    ),
    instructions = "Eres un asistente conversacional amigable. Responde de forma natural como en una llamada telef√≥nica."
)
```

### WebRTC - Endpoints
- **Token ef√≠mero:** `POST https://api.openai.com/v1/realtime/client_secrets`
- **SDP Exchange:** `POST https://api.openai.com/v1/realtime/calls`

---

## üìù Notas Importantes

### Seguridad
‚ö†Ô∏è **API Key Hardcoded:** Actualmente la API key est√° hardcoded para desarrollo. **NUNCA** publicar la app as√≠.
- **TODO:** Implementar backend simple para generar tokens ef√≠meros
- Opciones: Cloud Function, Vercel, Netlify, servidor propio

### Flujo de la Llamada
1. Usuario presiona "Iniciar Llamada"
2. App solicita permisos de micr√≥fono
3. Se genera token ef√≠mero (o se usa API key directa)
4. Se establece conexi√≥n WebRTC con OpenAI
5. Se configura sesi√≥n con VAD autom√°tico
6. Usuario habla ‚Üí VAD detecta ‚Üí OpenAI escucha
7. Usuario termina de hablar ‚Üí VAD detecta silencio ‚Üí IA responde
8. Audio de IA se reproduce autom√°ticamente
9. Transcripciones aparecen en tiempo real en la UI
10. Ciclo se repite hasta que el usuario finaliza la llamada

### Limitaciones Conocidas
- Duraci√≥n m√°xima de sesi√≥n: 30 minutos
- VAD solo funciona con audio continuo
- La voz de la IA no se puede cambiar despu√©s de que empiece a hablar en una sesi√≥n
- WebRTC puede tener problemas en redes muy inestables

---

## üì¶ Estructura de Archivos del Proyecto

```
ai-english/
‚îú‚îÄ‚îÄ composeApp/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commonMain/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ kotlin/com/baccaro/ai/
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ domain/
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ openai/
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ClientEvents.kt ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ServerEvents.kt ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ           ‚îî‚îÄ‚îÄ CallModels.kt ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ webrtc/
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RealtimeWebRTCManager.kt ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ EventParser.kt ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ openai/
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ OpenAIRealtimeClient.kt ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ EventHandler.kt ‚úÖ
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ presentation/
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ call/
‚îÇ   ‚îÇ   ‚îÇ               ‚îú‚îÄ‚îÄ CallViewModel.kt ‚è≥
‚îÇ   ‚îÇ   ‚îÇ               ‚îú‚îÄ‚îÄ CallScreen.kt ‚è≥
‚îÇ   ‚îÇ   ‚îÇ               ‚îî‚îÄ‚îÄ components/ ‚è≥
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ androidMain/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ kotlin/com/baccaro/ai/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ platform/
‚îÇ   ‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ AudioManager.android.kt ‚è≥
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ iosMain/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ kotlin/com/baccaro/ai/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ platform/
‚îÇ   ‚îÇ               ‚îî‚îÄ‚îÄ AudioManager.ios.kt ‚è≥
‚îÇ   ‚îî‚îÄ‚îÄ build.gradle.kts ‚úÖ
‚îú‚îÄ‚îÄ iosApp/
‚îÇ   ‚îú‚îÄ‚îÄ Podfile ‚úÖ
‚îÇ   ‚îî‚îÄ‚îÄ iosApp/
‚îÇ       ‚îî‚îÄ‚îÄ Info.plist ‚è≥
‚îú‚îÄ‚îÄ gradle/
‚îÇ   ‚îî‚îÄ‚îÄ libs.versions.toml ‚úÖ
‚îú‚îÄ‚îÄ build.gradle.kts ‚úÖ
‚îî‚îÄ‚îÄ PLAN.md ‚úÖ (este archivo)
```

**Leyenda:**
- ‚úÖ Completado
- üîÑ En progreso
- ‚è≥ Pendiente

---

## üéØ Pr√≥ximos Pasos Inmediatos

1. **COMPLETADO:** ~~Implementar `RealtimeWebRTCManager` (Fase 3)~~ ‚úÖ
2. **COMPLETADO:** ~~Implementar `OpenAIRealtimeClient` (Fase 4)~~ ‚úÖ
3. **SIGUIENTE:** Configurar permisos de audio (Fase 5)
4. **DESPU√âS:** Crear UI con Compose (Fase 6)
5. **FINALMENTE:** Testing completo (Fase 7)

---

*√öltima actualizaci√≥n: 26 de Octubre, 2025 - Fases 3 y 4 completadas exitosamente*
